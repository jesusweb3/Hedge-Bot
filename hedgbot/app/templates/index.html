<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Hedg-Bot панель управления</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <header class="app-header">
      <h1>Hedg-Bot — управление стратегиями</h1>
      <div class="global-controls">
        <button id="start-all" class="primary">Запустить все</button>
        <button id="stop-all" class="secondary">Остановить все</button>
      </div>
    </header>

    <main>
      <section class="instruments">
        {% for instrument in state.instruments %}
        <article class="instrument-card" data-symbol="{{ instrument.symbol }}">
          <header>
            <h2>{{ instrument.symbol }}</h2>
            <span class="status-indicator" data-running="{{ 'true' if instrument.is_running else 'false' }}">
              {{ 'Работает' if instrument.is_running else 'Остановлен' }}
            </span>
          </header>

          <nav class="tab-bar">
            <button class="tab-button active" data-target="settings">Настройки</button>
            <button class="tab-button" data-target="status">Статус / Запуск</button>
            <button class="tab-button" data-target="orders">Ордеры</button>
            <button class="tab-button" data-target="logs">Лог</button>
          </nav>

          <section class="tab-content settings active" data-tab="settings">
            <form class="config-form">
              <input type="hidden" name="symbol" value="{{ instrument.symbol }}" />
              <div class="field-group">
                <label>Объём входа (USDT)
                  <input type="number" step="0.01" name="entry_amount" value="{{ instrument.config.entry_amount }}" required />
                </label>
              </div>

              <fieldset>
                <legend>Тейк-профиты</legend>
                {% for tp in instrument.config.take_profits %}
                <div class="tp-row" data-label="{{ tp.label }}">
                  <strong>{{ tp.label }}</strong>
                  <label>
                    Отступ (%):
                    <input type="number" step="0.01" name="tp-offset" value="{{ tp.offset_percent }}" required />
                  </label>
                  <label>
                    Объём (%):
                    <input type="number" step="0.01" name="tp-volume" value="{{ tp.volume_percent }}" required />
                  </label>
                </div>
                {% endfor %}
              </fieldset>

              <fieldset class="stop-loss-container">
                <legend>Стоп-лоссы</legend>
                <div class="stop-loss-list">
                  {% for sl in instrument.config.stop_losses %}
                  <div class="stop-loss-row">
                    <label>
                      Отступ (%):
                      <input type="number" step="0.01" name="sl-offset" value="{{ sl.offset_percent }}" required />
                    </label>
                    <label>
                      Объём (%):
                      <input type="number" step="0.01" name="sl-volume" value="{{ sl.volume_percent }}" required />
                    </label>
                    <button type="button" class="remove-stop">×</button>
                  </div>
                  {% endfor %}
                </div>
                <button type="button" class="add-stop">Добавить стоп</button>
              </fieldset>

              <fieldset class="dca-settings">
                <legend>Доливка после TP1</legend>
                <label class="checkbox">
                  <input type="checkbox" name="dca-enabled" {% if instrument.config.tp1_dca.enabled %}checked{% endif %} />
                  Использовать доливку после TP1
                </label>
                <div class="dca-fields">
                  <label>
                    Отступ (%):
                    <input type="number" step="0.01" name="dca-offset" value="{{ instrument.config.tp1_dca.offset_percent or '' }}" />
                  </label>
                  <label>
                    Объём (контракты):
                    <input type="number" step="0.01" name="dca-quantity" value="{{ instrument.config.tp1_dca.quantity or '' }}" />
                  </label>
                </div>
              </fieldset>

              <footer class="form-actions">
                <button type="submit" class="primary">Сохранить настройки</button>
              </footer>
            </form>
          </section>

          <section class="tab-content status" data-tab="status">
            <div class="status-panel">
              <p>Состояние: <span class="status-text">{{ 'Работает' if instrument.is_running else 'Остановлен' }}</span></p>
              <div class="positions">
                <h3>Размер позиции</h3>
                <ul>
                  <li>Long: <span data-position="LONG">{{ instrument.positions['LONG'] }}</span></li>
                  <li>Short: <span data-position="SHORT">{{ instrument.positions['SHORT'] }}</span></li>
                </ul>
              </div>
              <div class="status-actions">
                <button class="primary start">Старт</button>
                <button class="secondary stop">Стоп</button>
                <button class="danger close">Закрыть всё вручную</button>
              </div>
            </div>
          </section>

          <section class="tab-content orders" data-tab="orders">
            <div class="orders-list">
              <h3>Активные ордера</h3>
              <table class="open-orders">
                <thead>
                  <tr><th>ID</th><th>Тип</th><th>Сторона</th><th>Кол-во</th><th>Статус</th></tr>
                </thead>
                <tbody>
                  {% for order in instrument.open_orders %}
                  <tr>
                    <td>{{ order.id }}</td>
                    <td>{{ order.type }}</td>
                    <td>{{ order.side }}</td>
                    <td>{{ order.quantity }}</td>
                    <td>{{ order.status }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>

              <h3>Доливки</h3>
              <table class="dca-table">
                <thead>
                  <tr><th>ID</th><th>Сторона</th><th>Кол-во</th><th>Статус</th></tr>
                </thead>
                <tbody>
                  {% for order in instrument.dca_orders %}
                  <tr>
                    <td>{{ order.id }}</td>
                    <td>{{ order.side }}</td>
                    <td>{{ order.quantity }}</td>
                    <td>{{ order.status }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </section>

          <section class="tab-content logs" data-tab="logs">
            <div class="log-list">
              <button type="button" class="refresh primary">Обновить</button>
              <ul>
                {% for entry in instrument.logs | reverse %}
                <li>
                  <time>{{ entry.timestamp }}</time>
                  <span class="level level-{{ entry.level.lower() }}">{{ entry.level }}</span>
                  <span class="message">{{ entry.message }}</span>
                </li>
                {% endfor %}
              </ul>
            </div>
          </section>
        </article>
        {% endfor %}
      </section>
    </main>

    <script src="/static/app.js"></script>
  </body>
</html>
